#!/usr/bin/env node

const package = require('../package.json')
const program = require('commander');
const fs = require('fs')
const path = require('path')

const NodeDeploy = require('../lib/deploy/node').default
const NodeZipBuilder = require('../lib/builder/node-zip').default
const NodeZipUploader = require('../lib/uploader/node-zip').default
const NodeController = require('../lib/controller/node').default

const FunctionDeploy = require('../lib/deploy/function').default

const { login, logout, getSecret, askForInput } = require('../lib/utils')

program
  .version(package.version)
  .command('deploy [name]')
  .description('执行完整的发布')
  .option('--start', '发布后启动')
  .action(async function (name, options) {
    const { deploys, common } = getDeploys(name)
    for (let i = 0; i < deploys.length; i++) {
      const deploy = deploys[i]
      if (deploy.type === 'node') {
        if (!deploy.path) {
          throw new Error('未指定发布目录')
        }
        if (!common.server.host && !deploy.config.host) {
          deploy.config.host = await askForInput('请输入服务器IP：')
        }
        if (!common.server.password && !deploy.config.password) {
          deploy.config.password = await askForInput('请输入服务器密码：')
        }
        await new NodeDeploy({
          ...common.server,
          ...deploy
        }).deploy(options.start)
        continue;
      }
      if (deploy.type === 'function') {
        const { secretId, secretKey } = await getSecret()
        await new FunctionDeploy({
          ...common,
          ...deploy,
          secretId,
          secretKey
        }).deploy()
        continue;
      }
      throw new Error(`Unsupported deploy type: "${deploy.type}"`)
    }
  })

program
  .command('login')
  .description('登录腾讯云账号')
  .action(login)

program
  .command('logout')
  .description('登出腾讯云账号')
  .action(logout)

program
  .command('build [name]')
  .description('构建')
  .action(async function (name) {
    const { deploys, common } = getDeploys(name)
    for (let i = 0; i < deploys.length; i++) {
      const deploy = deploys[i]
      if (deploy.type === 'node') {
        await new NodeZipBuilder({
          entry: deploy.entry,
          ...deploy
        }).build()
        continue;
      }
      throw new Error(`Unsupported build type: "${deploy.type}"`)
    }
  })

program
  .command('show <name>')
  .description('查看状态')
  .action(async function (name) {
    const { deploys: [deploy], common } = getDeploys(name)
    if (deploy.type === 'node') {
      await new NodeController({
        ...common.server,
        ...deploy.config,
        entry: deploy.entry,
      }).show()
    }
  })

program.
  command('logs <name>')
  .description('查看日志')
  .option('-n <n>', '输出日志的行数')
  .action(async function(name, options) {
    const { deploys: [deploy], common } = getDeploys(name)
    if (deploy.type === 'node') {
      await new NodeController({
        ...common.server,
        ...deploy
      }).logs({
        lines: options.n || 20
      })
    }
  })

program.parse(process.argv)

function getDeploys(name) {
  const configPath = process.cwd() + '/tcb.json'
  if (!fs.existsSync(configPath)) {
    throw new Error('未找到tcb配置文件')
  }
  const tcbConfig = require(configPath)
  let deploys = tcbConfig.deploys
  checkDeploys(deploys)
  if (name) {
    deploys = deploys.filter(d => d.name === name)
  }
  return {
    common: {
      ...tcbConfig.common,
      server: {
        username: 'root',
        port: 22,
        ...tcbConfig.common.server
      }
    },
    deploys
  }
}

function checkDeploys(deploys) {
  const names = {}
  deploys.forEach(d => {
    if (names[d.name]) {
      throw new Error(`Duplicated depoly name: "${d.name}"`)
    }
    names[d.name] = true
  })
}

